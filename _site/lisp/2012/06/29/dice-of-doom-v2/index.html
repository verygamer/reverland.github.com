
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Dice of Doom v2</title>
    
    <meta name="author" content="Reverland">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">
    <link href="/css/syntax.css" rel="stylesheet" type="text/css" media="all">

    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <script type="text/javascript" src="/js/jquery.js"></script>
    <script type="text/javascript" src="/js/bootstrap.min.js"></script>
    <div style="display:none">
      <!--cnzz-->
      <script src="http://s22.cnzz.com/stat.php?id=4548201&web_id=4548201" language="JavaScript"></script>
    </div>
    <!-- Le fav and touch icons -->
    <link rel="shortcut icon" href="/images/favicon.ico">
    <!-- Update these with your own images
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
    -->
    
  </head>

  <body>

    <!--[if lt IE 8]><div style='border:1px solid #F7941D;background:#FEEFDA;text-align:center;clear:both;height:75px;position:relative;'><div style='position:absolute;right:3px;top:3px;font-family:courier new;font-weight:bold;'><a href='#' onclick='javascript:this.parentNode.parentNode.style.display="none";return false;'><img src='http://www.ie6nomore.com/files/theme/ie6nomore-cornerx.jpg' style='border:none;' alt='Close this notice'/></a></div><div style='width:640px;margin:0 auto;text-align:left;padding:0;overflow:hidden;color:black;'><div style='width:75px;float:left;'><img src='http://www.ie6nomore.com/files/theme/ie6nomore-warning.jpg' alt='Warning!'/></div><div style='width:275px;float:left;font-family:Arial,sans-serif;'><div style='font-size:14px;font-weight:bold;margin-top:12px;'>You are using an outdated browser</div><div style='font-size:12px;margin-top:6px;line-height:12px;'>For a better experience using this site, please upgrade to a modern web browser.</div></div><div style='width:75px;float:left;'><a href='http://www.firefox.com' target='_blank'><img src='http://www.ie6nomore.com/files/theme/ie6nomore-firefox.jpg' style='border:none;' alt='Get Firefox 3.5'/></a></div><div style='width:75px;float:left;'><a href='http://www.browserforthebetter.com/download.html' target='_blank'><img src='http://www.ie6nomore.com/files/theme/ie6nomore-ie8.jpg' style='border:none;' alt='Get IE 8'/></a></div><div style='width:73px;float:left;'><a href='http://www.apple.com/safari/download/' target='_blank'><img src='http://www.ie6nomore.com/files/theme/ie6nomore-safari.jpg' style='border:none;' alt='Get Safari 4'/></a></div><div style='float:left;'><a href='http://www.google.com/chrome' target='_blank'><img src='http://www.ie6nomore.com/files/theme/ie6nomore-chrome.jpg' style='border:none;' alt='Get Google Chrome'/></a></div></div></div><![endif]-->


    <div class="navbar" id="top-navbar">
      <div class="navbar-inner">
	<div class="container">
	  <a class="brand" href="/">Reverland的行知阁</a>
	  <ul class="nav">
	    
	    
	    


  
    
  
    
    	
    	<li><a href="/about.html">关于</a></li>
    	
    
  
    
  
    
    	
    	<li><a href="/archive.html">归档</a></li>
    	
    
  
    
    	
    	<li><a href="/categories.html">分类</a></li>
    	
    
  
    
  
    
    	
    	<li><a href="/tags.html">标签</a></li>
    	
    
  
    
  
    
  
    
  
    
  
    
  
    
  



	  </ul>
	  <ul class="nav subscription pull-right" data-subscription="rss">
	    <li>
	    <a href="/atom.xml" rel="nofollow" title="subscribe via RSS">RSS</a>
	    </li>
	  </ul>
	  <form class="navbar-search pull-right" method="get" action="http://www.google.com/search" target="google_window">
	    <label for="g_search" class="hidden"></label>
	    <input id="g_search" type="text" class="search-query" placeholder="Search..." name="q" />
	    <input type="submit" name=”btnG” style="display:none" id="searchsubmit" value="Search" />
	    <input type="hidden" name="ie" value="UTF-8" />
	    <input type="hidden" name="oe" value="UTF-8" />
	    <input type="hidden" name="hl" value="zh-CN" />
	    <input type="hidden" name="domains" value="http://reverland.org" />
	    <input type="hidden" name="sitesearch" value="http://reverland.org" />
	  </form>
	</div>
      </div>
    </div>

    <div class="container">

      <div id="main-content" class="content">
	
<div class="page-header">
    <h1>Dice of Doom v2 <small><!--Supporting tagline--></small></h1>
</div>

<div class="row">
  <div id="article_indent" class="span9 pull-left">
    <div class="span3 article_published">发表于
      <span class="date">29 June 2012</span>
      <div class="article_gplus"><div class="g-plusone" data-size="small" data-annotation="none"></div></div>
    </div>
    <div class="clear"></div>
    
      <h1>Dice of Doom v2</h1>
<p>我已经不怎么看得懂在讲什么了，所以胡言乱语请见谅,有几个问题:</p>
<ol>
	<li>记不起之前的游戏树什么样了，我又懒得回头去看。是不是某种决策树？</li>
	<li>不停的函数接着函数扩展看起来很方便，但又要求你时刻记得之前实现的细节，以实现正确的改进</li>
	<li>作者的编程风格，以后还是按htdp里说的玩去吧，起码不会像现在这样晕。</li>
	<li>英语还是障碍啊，有时候看完一大段文字后不知道在讲什么，囧了。</li>
</ol>
<h2>Dice of Doom v2</h2>
<p>首先加载之前我们完成的 <a href="/lisp/2012/05/23/dice-of-doom/">Dice of Doom</a> 源码和为惰性求值所实现的一系列库文件。没有的话就从land of lisp网站上下载吧，话说这本书真贵要40刀左右，豆瓣上竟然380元人民币……</p>
<div class="highlight"><pre><code class="cl"><span class="p">(</span><span class="nb">load</span> <span class="s">&quot;dice_of_doom_v1.lisp&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="nb">load</span> <span class="s">&quot;lazy.lisp&quot;</span><span class="p">)</span>
</code></pre>
</div>
<p>然后先把游戏board扩大到4x4。</p>
<div class="highlight"><pre><code class="cl"><span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*board-size*</span> <span class="mi">4</span><span class="p">)</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*board-hexnum*</span> <span class="p">(</span><span class="nb">*</span> <span class="vg">*board-size*</span> <span class="vg">*board-size*</span><span class="p">))</span>
</code></pre>
</div>
<p>下面把Dice of Doom游戏全面lazy化吧</p>
<div class="highlight"><pre><code class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">add-passing-move</span> <span class="p">(</span><span class="nv">board</span> <span class="nv">player</span> <span class="nv">spare-dice</span> <span class="nv">first-move</span> <span class="nv">moves</span><span class="p">)</span>
  <span class="p">(</span><span class="k">if</span> <span class="nv">first-move</span>
    <span class="nv">moves</span>
    <span class="p">(</span><span class="nv">lazy-cons</span> <span class="p">(</span><span class="nb">list</span> <span class="no">nil</span>
                     <span class="p">(</span><span class="nv">game-tree</span> <span class="p">(</span><span class="nv">add-new-dice</span> <span class="nv">board</span> <span class="nv">player</span>
                                              <span class="p">(</span><span class="nb">1-</span> <span class="nv">spare-dice</span><span class="p">))</span>
                                <span class="p">(</span><span class="nb">mod</span> <span class="p">(</span><span class="nb">1+</span> <span class="nv">player</span><span class="p">)</span> <span class="vg">*num-players*</span><span class="p">)</span>
                                <span class="mi">0</span>
                                <span class="no">t</span><span class="p">))</span>
               <span class="nv">moves</span><span class="p">)))</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">attacking-moves</span> <span class="p">(</span><span class="nv">board</span> <span class="nv">cur-player</span> <span class="nv">spare-dice</span><span class="p">)</span>
  <span class="p">(</span><span class="k">labels</span> <span class="p">((</span><span class="nv">player</span> <span class="p">(</span><span class="nv">pos</span><span class="p">)</span>
             <span class="p">(</span><span class="nb">car</span> <span class="p">(</span><span class="nb">aref</span> <span class="nv">board</span> <span class="nv">pos</span><span class="p">)))</span>
           <span class="p">(</span><span class="nv">dice</span> <span class="p">(</span><span class="nv">pos</span><span class="p">)</span>
             <span class="p">(</span><span class="nb">cadr</span> <span class="p">(</span><span class="nb">aref</span> <span class="nv">board</span> <span class="nv">pos</span><span class="p">))))</span>
    <span class="p">(</span><span class="nv">lazy-mapcan</span>
      <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">src</span><span class="p">)</span>
        <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">eq</span> <span class="p">(</span><span class="nv">player</span> <span class="nv">src</span><span class="p">)</span> <span class="nv">cur-player</span><span class="p">)</span>
          <span class="p">(</span><span class="nv">lazy-mapcan</span>
            <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">dst</span><span class="p">)</span>
              <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">and</span> <span class="p">(</span><span class="nb">not</span> <span class="p">(</span><span class="nb">eq</span> <span class="p">(</span><span class="nv">player</span> <span class="nv">dst</span><span class="p">)</span>
                                <span class="nv">cur-player</span><span class="p">))</span>
                       <span class="p">(</span><span class="nb">&gt;</span> <span class="p">(</span><span class="nv">dice</span> <span class="nv">src</span><span class="p">)</span> <span class="p">(</span><span class="nv">dice</span> <span class="nv">dst</span><span class="p">)))</span>
                <span class="p">(</span><span class="nv">make-lazy</span>
                  <span class="p">(</span><span class="nb">list</span> <span class="p">(</span><span class="nb">list</span> <span class="p">(</span><span class="nb">list</span> <span class="nv">src</span> <span class="nv">dst</span><span class="p">)</span>
                              <span class="p">(</span><span class="nv">game-tree</span> <span class="p">(</span><span class="nv">board-attack</span> <span class="nv">board</span>
                                                       <span class="nv">cur-player</span>
                                                       <span class="nv">src</span>
                                                       <span class="nv">dst</span>
                                                       <span class="p">(</span><span class="nv">dice</span> <span class="nv">src</span><span class="p">))</span>
                                         <span class="nv">cur-player</span>
                                         <span class="p">(</span><span class="nb">+</span> <span class="nv">spare-dice</span> <span class="p">(</span><span class="nv">dice</span> <span class="nv">dst</span><span class="p">))</span>
                                         <span class="no">nil</span><span class="p">))))</span>
                <span class="p">(</span><span class="nv">lazy-nil</span><span class="p">)))</span>
            <span class="p">(</span><span class="nv">make-lazy</span> <span class="p">(</span><span class="nv">neighbors</span> <span class="nv">src</span><span class="p">)))</span>
          <span class="p">(</span><span class="nv">lazy-nil</span><span class="p">)))</span>
      <span class="p">(</span><span class="nv">make-lazy</span> <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">n</span> <span class="nv">below</span> <span class="vg">*board-hexnum*</span>
                       <span class="nv">collect</span> <span class="nv">n</span><span class="p">)))))</span>
</code></pre>
</div>
<p>注意lazy-mapcan要求被创建的列表是惰性的，现在你知道htdp标明每个函数输入输出的习惯多好了吧……</p>
<p>lazy化handle-human函数和play-vs-human函数</p>
<div class="highlight"><pre><code class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">handle-human</span> <span class="p">(</span><span class="nv">tree</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">fresh-line</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">princ</span> <span class="s">&quot;choose your move:&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">moves</span> <span class="p">(</span><span class="nb">caddr</span> <span class="nv">tree</span><span class="p">)))</span>
    <span class="p">(</span><span class="k">labels</span> <span class="p">((</span><span class="nv">print-moves</span> <span class="p">(</span><span class="nv">moves</span> <span class="nv">n</span><span class="p">)</span>
               <span class="p">(</span><span class="nb">unless</span> <span class="p">(</span><span class="nv">lazy-null</span> <span class="nv">moves</span><span class="p">)</span>
                 <span class="p">(</span><span class="k">let*</span> <span class="p">((</span><span class="nv">move</span> <span class="p">(</span><span class="nv">lazy-car</span> <span class="nv">moves</span><span class="p">))</span>
                        <span class="p">(</span><span class="nv">action</span> <span class="p">(</span><span class="nb">car</span> <span class="nv">move</span><span class="p">)))</span>
                   <span class="p">(</span><span class="nb">fresh-line</span><span class="p">)</span>
                   <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~a. &quot;</span> <span class="nv">n</span><span class="p">)</span>
                   <span class="p">(</span><span class="k">if</span> <span class="nv">action</span>
                     <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~a -&gt; ~a&quot;</span> <span class="p">(</span><span class="nb">car</span> <span class="nv">action</span><span class="p">)</span> <span class="p">(</span><span class="nb">cadr</span> <span class="nv">action</span><span class="p">))</span>
                     <span class="p">(</span><span class="nb">princ</span> <span class="s">&quot;end turn&quot;</span><span class="p">)))</span>
                 <span class="p">(</span><span class="nv">print-moves</span> <span class="p">(</span><span class="nv">lazy-cdr</span> <span class="nv">moves</span><span class="p">)</span> <span class="p">(</span><span class="nb">1+</span> <span class="nv">n</span><span class="p">)))))</span>
      <span class="p">(</span><span class="nv">print-moves</span> <span class="nv">moves</span> <span class="mi">1</span><span class="p">))</span>
    <span class="p">(</span><span class="nb">fresh-line</span><span class="p">)</span>
    <span class="p">(</span><span class="nb">cadr</span> <span class="p">(</span><span class="nv">lazy-nth</span> <span class="p">(</span><span class="nb">1-</span> <span class="p">(</span><span class="nb">read</span><span class="p">))</span> <span class="nv">moves</span><span class="p">))))</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">play-vs-human</span> <span class="p">(</span><span class="nv">tree</span><span class="p">)</span>
  <span class="p">(</span><span class="nv">print-info</span> <span class="nv">tree</span><span class="p">)</span>
  <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">not</span> <span class="p">(</span><span class="nv">lazy-null</span> <span class="p">(</span><span class="nb">caddr</span> <span class="nv">tree</span><span class="p">)))</span>
    <span class="p">(</span><span class="nv">play-vs-human</span> <span class="p">(</span><span class="nv">handle-human</span> <span class="nv">tree</span><span class="p">))</span>
    <span class="p">(</span><span class="nv">announce-winner</span> <span class="p">(</span><span class="nb">cadr</span> <span class="nv">tree</span><span class="p">))))</span>
</code></pre>
</div>
<p>现在你可以试试人人对战了，速度不错。</p>
<h2>让AI运行在更大的游戏区域</h2>
<p>对AI的惰性化之前，我们先做一些修剪的工作，这是对AI决策树/游戏树算法的优化<sup class="footnote" id="fnr1"><a href="#fn1">1</a></sup>。</p>
<p>我们现在的AI很尽职尽责的搜索计算所有的可能的结果。但在大的游戏面板中这样很累，为了在效率上取得平衡，限制AI的考虑决策树深度</p>
<div class="highlight"><pre><code class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">limit-tree-depth</span> <span class="p">(</span><span class="nv">tree</span> <span class="nv">depth</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">list</span> <span class="p">(</span><span class="nb">car</span> <span class="nv">tree</span><span class="p">)</span>
        <span class="p">(</span><span class="nb">cadr</span> <span class="nv">tree</span><span class="p">)</span>
        <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">zerop</span> <span class="nv">depth</span><span class="p">)</span>
          <span class="p">(</span><span class="nv">lazy-nil</span><span class="p">)</span>
          <span class="p">(</span><span class="nv">lazy-mapcar</span> <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">move</span><span class="p">)</span>
                         <span class="p">(</span><span class="nb">list</span> <span class="p">(</span><span class="nb">car</span> <span class="nv">move</span><span class="p">)</span>
                               <span class="p">(</span><span class="nv">limit-tree-depth</span> <span class="p">(</span><span class="nb">cadr</span> <span class="nv">move</span><span class="p">)</span> <span class="p">(</span><span class="nb">1-</span> <span class="nv">depth</span><span class="p">))))</span>
                       <span class="p">(</span><span class="nb">caddr</span> <span class="nv">tree</span><span class="p">)))))</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*ai-level*</span> <span class="mi">4</span><span class="p">)</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">handle-computer</span> <span class="p">(</span><span class="nv">tree</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">ratings</span> <span class="p">(</span><span class="nv">get-ratings</span> <span class="p">(</span><span class="nv">limit-tree-depth</span> <span class="nv">tree</span> <span class="vg">*ai-level*</span><span class="p">)</span>
                              <span class="p">(</span><span class="nb">car</span> <span class="nv">tree</span><span class="p">))))</span>
    <span class="p">(</span><span class="nb">cadr</span> <span class="p">(</span><span class="nv">lazy-nth</span> <span class="p">(</span><span class="nb">position</span> <span class="p">(</span><span class="nb">apply</span> <span class="nf">#&#39;</span><span class="nb">max</span> <span class="nv">ratings</span><span class="p">)</span> <span class="nv">ratings</span><span class="p">)</span>
                    <span class="p">(</span><span class="nb">caddr</span> <span class="nv">tree</span><span class="p">)))))</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">play-vs-computer</span> <span class="p">(</span><span class="nv">tree</span><span class="p">)</span>
  <span class="p">(</span><span class="nv">print-info</span> <span class="nv">tree</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">cond</span> <span class="p">((</span><span class="nv">lazy-null</span> <span class="p">(</span><span class="nb">caddr</span> <span class="nv">tree</span><span class="p">))</span> <span class="p">(</span><span class="nv">announce-winner</span> <span class="p">(</span><span class="nb">cadr</span> <span class="nv">tree</span><span class="p">)))</span>
        <span class="p">((</span><span class="nb">zerop</span> <span class="p">(</span><span class="nb">car</span> <span class="nv">tree</span><span class="p">))</span> <span class="p">(</span><span class="nv">play-vs-computer</span> <span class="p">(</span><span class="nv">handle-human</span> <span class="nv">tree</span><span class="p">)))</span>
        <span class="p">(</span><span class="no">t</span> <span class="p">(</span><span class="nv">play-vs-computer</span> <span class="p">(</span><span class="nv">handle-computer</span> <span class="nv">tree</span><span class="p">)))))</span>
</code></pre>
</div>
<p>我没看懂……已经深深迷失在car cadr caddr的海洋之中，总之它限制了AI的思考深度，让它把评分限制在4步之内。<sup class="footnote" id="fnr2"><a href="#fn2">2</a></sup></p>
<h3>启发算法<sup class="footnote" id="fnr3"><a href="#fn3">3</a></sup></h3>
<p>让AI只思考较少的深度来实现投入和产出的统一。</p>
<p>让我们用更复杂的启发算法来重新对游戏面板评分:对一个自己的地盘，如果附近有比自己强大的敌人则评分1,否则则评分2。若该地盘属于对手则评分为-1</p>
<div class="highlight"><pre><code class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">score-board</span> <span class="p">(</span><span class="nv">board</span> <span class="nv">player</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">hex</span> <span class="nv">across</span> <span class="nv">board</span>
        <span class="nv">for</span> <span class="nv">pos</span> <span class="nv">from</span> <span class="mi">0</span>
        <span class="nv">sum</span> <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">eq</span> <span class="p">(</span><span class="nb">car</span> <span class="nv">hex</span><span class="p">)</span> <span class="nv">player</span><span class="p">)</span>
              <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nv">threatened</span> <span class="nv">pos</span> <span class="nv">board</span><span class="p">)</span>
                <span class="mi">1</span>
                <span class="mi">2</span><span class="p">)</span>
              <span class="mi">-1</span><span class="p">)))</span>
<span class="c1">;附近有更多骰子的位置有威胁</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">threatened</span> <span class="p">(</span><span class="nv">pos</span> <span class="nv">board</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let*</span> <span class="p">((</span><span class="nv">hex</span> <span class="p">(</span><span class="nb">aref</span> <span class="nv">board</span> <span class="nv">pos</span><span class="p">))</span>
         <span class="p">(</span><span class="nv">player</span> <span class="p">(</span><span class="nb">car</span> <span class="nv">hex</span><span class="p">))</span>
         <span class="p">(</span><span class="nv">dice</span> <span class="p">(</span><span class="nb">cadr</span> <span class="nv">hex</span><span class="p">)))</span>
    <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">n</span> <span class="nv">in</span> <span class="p">(</span><span class="nv">neighbors</span> <span class="nv">pos</span><span class="p">)</span>
          <span class="nb">do</span> <span class="p">(</span><span class="k">let*</span> <span class="p">((</span><span class="nv">nhex</span> <span class="p">(</span><span class="nb">aref</span> <span class="nv">board</span> <span class="nv">n</span><span class="p">))</span>
                    <span class="p">(</span><span class="nv">nplayer</span> <span class="p">(</span><span class="nb">car</span> <span class="nv">nhex</span><span class="p">))</span>
                    <span class="p">(</span><span class="nv">ndice</span> <span class="p">(</span><span class="nb">cadr</span> <span class="nv">nhex</span><span class="p">)))</span>
               <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nb">and</span> <span class="p">(</span><span class="nb">not</span> <span class="p">(</span><span class="nb">eq</span> <span class="nv">player</span> <span class="nv">nplayer</span><span class="p">))</span> <span class="p">(</span><span class="nb">&gt;</span> <span class="nv">ndice</span> <span class="nv">dice</span><span class="p">))</span>
                 <span class="p">(</span><span class="nb">return</span> <span class="no">t</span><span class="p">))))))</span>
</code></pre>
</div>
<p>有意思的是，关于启发式作者这么说：在开发这个例子时，我模拟了使用不同版本score-board的各种对手，这个版本效果很好，开发启发式算法不是什么科学。囧～</p>
<p>惰性化get-ratings和rate-position函数</p>
<div class="highlight"><pre><code class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">get-ratings</span> <span class="p">(</span><span class="nv">tree</span> <span class="nv">player</span><span class="p">)</span>
  <span class="p">(</span><span class="nv">take-all</span> <span class="p">(</span><span class="nv">lazy-mapcar</span> <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">move</span><span class="p">)</span>
                           <span class="p">(</span><span class="nv">rate-position</span> <span class="p">(</span><span class="nb">cadr</span> <span class="nv">move</span><span class="p">)</span> <span class="nv">player</span><span class="p">))</span>
                         <span class="p">(</span><span class="nb">caddr</span> <span class="nv">tree</span><span class="p">))))</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">rate-position</span> <span class="p">(</span><span class="nv">tree</span> <span class="nv">player</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">moves</span> <span class="p">(</span><span class="nb">caddr</span> <span class="nv">tree</span><span class="p">)))</span>
    <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">not</span> <span class="p">(</span><span class="nv">lazy-null</span> <span class="nv">moves</span><span class="p">))</span>
      <span class="p">(</span><span class="nb">apply</span> <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">eq</span> <span class="p">(</span><span class="nb">car</span> <span class="nv">tree</span><span class="p">)</span> <span class="nv">player</span><span class="p">)</span>
               <span class="nf">#&#39;</span><span class="nb">max</span>
               <span class="nf">#&#39;</span><span class="nb">min</span><span class="p">)</span>
             <span class="p">(</span><span class="nv">get-ratings</span> <span class="nv">tree</span> <span class="nv">player</span><span class="p">))</span>
      <span class="p">(</span><span class="nv">score-board</span> <span class="p">(</span><span class="nb">cadr</span> <span class="nv">tree</span><span class="p">)</span> <span class="nv">player</span><span class="p">))))</span>
</code></pre>
</div>
<p>现在可以试试和计算机过招了。</p>
<div class="highlight"><pre><code class="cl"><span class="p">(</span><span class="nv">play-vs-computer</span> <span class="p">(</span><span class="nv">game-tree</span> <span class="p">(</span><span class="nv">gen-board</span><span class="p">)</span> <span class="mi">0</span> <span class="mi">0</span> <span class="no">t</span><span class="p">))</span>
</code></pre>
</div>
<p>据说先行者有优势，计算机大概有3/4的几率获胜。</p>
<h3>alpha-beta 算法<sup class="footnote" id="fnr4"><a href="#fn4">4</a></sup></h3>
<code>此部分不只所云，请见谅。</code>
<p>AI实际上执行一种深度优先搜索。</p>
<p>alpha-beta算法是把已知的一定更差的子树从决策树中剪掉的算法，熟称剪枝算法。</p>
<p>本游戏中游戏树的顶端上是最大最小算法，非顶端上是score-board评分……</p>
<div class="highlight"><pre><code class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">ab-get-ratings-max</span> <span class="p">(</span><span class="nv">tree</span> <span class="nv">player</span> <span class="nv">upper-limit</span> <span class="nv">lower-limit</span><span class="p">)</span>
  <span class="p">(</span><span class="k">labels</span> <span class="p">((</span><span class="nv">f</span> <span class="p">(</span><span class="nv">moves</span> <span class="nv">lower-limit</span><span class="p">)</span>
             <span class="p">(</span><span class="nb">unless</span> <span class="p">(</span><span class="nv">lazy-null</span> <span class="nv">moves</span><span class="p">)</span>
               <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">x</span> <span class="p">(</span><span class="nv">ab-rate-position</span> <span class="p">(</span><span class="nb">cadr</span> <span class="p">(</span><span class="nv">lazy-car</span> <span class="nv">moves</span><span class="p">))</span>
                                          <span class="nv">player</span>
                                          <span class="nv">upper-limit</span>
                                          <span class="nv">lower-limit</span><span class="p">)))</span>
                 <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">&gt;=</span> <span class="nv">x</span> <span class="nv">upper-limit</span><span class="p">)</span>
                   <span class="p">(</span><span class="nb">list</span> <span class="nv">x</span><span class="p">)</span>
                   <span class="p">(</span><span class="nb">cons</span> <span class="nv">x</span> <span class="p">(</span><span class="nv">f</span> <span class="p">(</span><span class="nv">lazy-cdr</span> <span class="nv">moves</span><span class="p">)</span> <span class="p">(</span><span class="nb">max</span> <span class="nv">x</span> <span class="nv">lower-limit</span><span class="p">))))))))</span>
    <span class="p">(</span><span class="nv">f</span> <span class="p">(</span><span class="nb">caddr</span> <span class="nv">tree</span><span class="p">)</span> <span class="nv">lower-limit</span><span class="p">)))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">ab-get-ratings-min</span> <span class="p">(</span><span class="nv">tree</span> <span class="nv">player</span> <span class="nv">upper-limit</span> <span class="nv">lower-limit</span><span class="p">)</span>
  <span class="p">(</span><span class="k">labels</span> <span class="p">((</span><span class="nv">f</span> <span class="p">(</span><span class="nv">moves</span> <span class="nv">upper-limit</span><span class="p">)</span>
             <span class="p">(</span><span class="nb">unless</span> <span class="p">(</span><span class="nv">lazy-null</span> <span class="nv">moves</span><span class="p">)</span>
               <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">x</span> <span class="p">(</span><span class="nv">ab-rate-position</span> <span class="p">(</span><span class="nb">cadr</span> <span class="p">(</span><span class="nv">lazy-car</span> <span class="nv">moves</span><span class="p">))</span>
                                          <span class="nv">player</span>
                                          <span class="nv">upper-limit</span>
                                          <span class="nv">lower-limit</span><span class="p">)))</span>
                 <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">&lt;=</span> <span class="nv">x</span> <span class="nv">lower-limit</span><span class="p">)</span>
                   <span class="p">(</span><span class="nb">list</span> <span class="nv">x</span><span class="p">)</span>
                   <span class="p">(</span><span class="nb">cons</span> <span class="nv">x</span> <span class="p">(</span><span class="nv">f</span> <span class="p">(</span><span class="nv">lazy-cdr</span> <span class="nv">moves</span><span class="p">)</span> <span class="p">(</span><span class="nb">min</span> <span class="nv">x</span> <span class="nv">upper-limit</span><span class="p">))))))))</span>
    <span class="p">(</span><span class="nv">f</span> <span class="p">(</span><span class="nb">caddr</span> <span class="nv">tree</span><span class="p">)</span> <span class="nv">upper-limit</span><span class="p">)))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">ab-rate-position</span> <span class="p">(</span><span class="nv">tree</span> <span class="nv">player</span> <span class="nv">upper-limit</span> <span class="nv">lower-limit</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">moves</span> <span class="p">(</span><span class="nb">caddr</span> <span class="nv">tree</span><span class="p">)))</span>
    <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">not</span> <span class="p">(</span><span class="nv">lazy-null</span> <span class="nv">moves</span><span class="p">))</span>
      <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">eq</span> <span class="p">(</span><span class="nb">car</span> <span class="nv">tree</span><span class="p">)</span> <span class="nv">player</span><span class="p">)</span>
        <span class="p">(</span><span class="nb">apply</span> <span class="nf">#&#39;</span><span class="nb">max</span> <span class="p">(</span><span class="nv">ab-get-ratings-max</span> <span class="nv">tree</span>
                                         <span class="nv">player</span>
                                         <span class="nv">upper-limit</span>
                                         <span class="nv">lower-limit</span><span class="p">))</span>
        <span class="p">(</span><span class="nb">apply</span> <span class="nf">#&#39;</span><span class="nb">min</span> <span class="p">(</span><span class="nv">ab-get-ratings-min</span> <span class="nv">tree</span>
                                         <span class="nv">player</span>
                                         <span class="nv">upper-limit</span>
                                         <span class="nv">lower-limit</span><span class="p">)))</span>
      <span class="p">(</span><span class="nv">score-board</span> <span class="p">(</span><span class="nb">cadr</span> <span class="nv">tree</span><span class="p">)</span> <span class="nv">player</span><span class="p">))))</span>
</code></pre>
</div>
<p>这三个函数怎么实现及实现什么……不知道，深感自己英语不行啊，大段大段看完不知道在讲什么，哪天有兴致了对照对弈程序基本技术再看吧……I am confused now.<sup class="footnote" id="fnr6"><a href="#fn6">6</a></sup></p>
<p>改进我们的handle-computer函数</p>
<div class="highlight"><pre><code class="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">handle-computer</span> <span class="p">(</span><span class="nv">tree</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">ratings</span> <span class="p">(</span><span class="nv">ab-get-ratings-max</span> <span class="p">(</span><span class="nv">limit-tree-depth</span> <span class="nv">tree</span> <span class="vg">*ai-level*</span><span class="p">)</span>
                                     <span class="p">(</span><span class="nb">car</span> <span class="nv">tree</span><span class="p">)</span>
                                     <span class="nv">most-positive-fixnum</span>
                                     <span class="nv">most-negative-fixnum</span><span class="p">)))</span>
    <span class="p">(</span><span class="nb">cadr</span> <span class="p">(</span><span class="nv">lazy-nth</span> <span class="p">(</span><span class="nb">position</span> <span class="p">(</span><span class="nb">apply</span> <span class="nf">#&#39;</span><span class="nb">max</span> <span class="nv">ratings</span><span class="p">)</span> <span class="nv">ratings</span><span class="p">)</span> <span class="p">(</span><span class="nb">caddr</span> <span class="nv">tree</span><span class="p">)))))</span>
</code></pre>
</div>
<p>现在把游戏面板扩大到5x5</p>
<div class="highlight"><pre><code class="cl"><span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*board-size*</span> <span class="mi">5</span><span class="p">)</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*board-hexnum*</span> <span class="p">(</span><span class="nb">*</span> <span class="vg">*board-size*</span> <span class="vg">*board-size*</span><span class="p">))</span>
</code></pre>
</div>
<p>由于我们记忆化的原因，之前的4x4面板会被缓存。为了修正这个问题重新定义neighbors函数即可。</p>
<p>实验新的经过改进的游戏</p>
<div class="highlight"><pre><code class="cl"><span class="p">(</span><span class="nv">play-vs-computer</span> <span class="p">(</span><span class="nv">game-tree</span> <span class="p">(</span><span class="nv">gen-board</span><span class="p">)</span> <span class="mi">0</span> <span class="mi">0</span> <span class="no">t</span><span class="p">))</span>
</code></pre>
</div>
<h2>小结</h2>
<p>本章我们使用惰性求值方法改进我们的游戏，同时通过一些优化限制AI引擎搜索的决策树数目，我们学到了以下几点：</p>
<ul>
	<li>惰性列表使你有可能使用无穷的列表和数据结构，并且很有效率</li>
	<li>一旦你有了lazy宏和force函数，你就可以基于此创造更复杂的惰性列表库</li>
	<li>启发性算法是不完美的算法，通过一些创造性的想法可以显著提高代码的性能。在我们的例子中我们使用启发式的算法来为游戏树的顶端评分。</li>
	<li>一旦我们把游戏转化为惰性树，为了限制AI思考的移动的深度我们可以优雅地<sup class="footnote" id="fnr5"><a href="#fn5">5</a></sup>修剪游戏树。</li>
	<li>Alpha-beta算法让我们更多地优化了性能，通过修剪不会影响AI最后所思考的移动的评分。</li>
</ul>
<hr />
<h2>Footnotes</h2>
<p class="footnote" id="fn1"><a href="#fnr1"><sup>1</sup></a> 我胡扯的，个人理解。</p>
<p class="footnote" id="fn2"><a href="#fnr2"><sup>2</sup></a> Note在讲什么我也不知道，只知道作者说这个虽然做的不够精细，但已经足够优化了。</p>
<p class="footnote" id="fn3"><a href="#fnr3"><sup>3</sup></a> 参见 <a href="http://en.wikipedia.org/wiki/Heuristic_(computer_science)" title="computer_science">http://en.wikipedia.org/wiki/Heuristic_</a></p>
<p class="footnote" id="fn4"><a href="#fnr4"><sup>4</sup></a> 参见 <a href="http://en.wikipedia.org/wiki/Alpha-beta_pruning">http://en.wikipedia.org/wiki/Alpha-beta_pruning</a></p>
<p class="footnote" id="fn5"><a href="#fnr5"><sup>5</sup></a> 编写新的函数，看上去很优雅……</p>
<p class="footnote" id="fn6"><a href="#fnr6"><sup>6</sup></a> 可以先看看 <a href="http://www.xqbase.com/computer/search_alphabeta.htm">alpha-beta剪枝算法</a></p>
<hr />
<h2>废话</h2>
<p>说实话，看不懂了，愈发的看不懂。生命中某种虚空感强烈的袭来，明知自己做的是“没有意义”，也没有人在意的的东西，可我就是关心那些。</p>
<p>有时候真是不想理人，与很多人不怎么谈得来，我不喜欢到头来毫无建树的胡扯，也不喜欢扯不喜欢的东西。可有时无话可说无人可诉，人与人的差别就是这么大，不知何时。</p>
<p>有时侯如此疯狂，讨厌别人的干扰，不能容忍自己浪费生命。在他人眼里我不也是在浪费生命？我不知道，安慰我的人永远安慰我，另一个部分人永远看不起我。</p>
<p>我应该追求哪个世界与人生？一边是迷人的，我不知道余生还有多长，不想放手错过它，但它只在我的梦中。一条在横亘在这个世界，我却没有一丝爱意。</p>
<p>也许一切都是宿命。</p>
    
    <hr>
    <div class="pagination">
      <ul>
      
        <li class="prev"><a href="/others/2012/06/28/google-glasses" title="Google glasses">&larr; Previous</a></li>
      
        <li><a href="/archive.html">Archive</a></li>
      
        <li class="next"><a href="/lisp/2012/07/02/webdice-of-doom" title="基于web的Dice of Doom">Next &rarr;</a></li>
      
      </ul>
    </div>
    <hr>
    


  <div id="disqus_container">
    <a href="#" class="comment btn btn-primary" onclick="return false;">点击查看评论</a>
    <div id="disqus_thread"></div>
</div>
<script type="text/javascript">
var show_comments = function(){
    
    var disqus_shortname = 'reverlandblog'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
};

$(document).ready(function(){
  $('#disqus_container>.comment').click(function(){
    $(this).html('加载中……');
	show_comments();
	$(this).remove();
  });
});

</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>




  </div>

  <div class="span3 pull-right">
    <ul class="nav nav-list">
      <li class="nav-header">分类</li>
      
       
        
        <li>
        
        <a href="/categories.html#linux-tech-ref">linux-tech <span>7</span></a>
        </li>
       
        
        <li class="active">
        
        <a href="/categories.html#lisp-ref">lisp <span>22</span></a>
        </li>
       
        
        <li>
        
        <a href="/categories.html#web-ref">web <span>2</span></a>
        </li>
       
        
        <li>
        
        <a href="/categories.html#reviews-ref">reviews <span>4</span></a>
        </li>
       
        
        <li>
        
        <a href="/categories.html#Life-ref">Life <span>13</span></a>
        </li>
       
        
        <li>
        
        <a href="/categories.html#scheme-ref">scheme <span>1</span></a>
        </li>
       
        
        <li>
        
        <a href="/categories.html#art-ref">art <span>1</span></a>
        </li>
       
        
        <li>
        
        <a href="/categories.html#others-ref">others <span>1</span></a>
        </li>
       
        
        <li>
        
        <a href="/categories.html#math-ref">math <span>1</span></a>
        </li>
       
        
        <li>
        
        <a href="/categories.html#test-ref">test <span>1</span></a>
        </li>
       
        
        <li>
        
        <a href="/categories.html#python-ref">python <span>18</span></a>
        </li>
      
      
        <li class="nav-header">Tags</li>
        
        


  
     
    	<li><a href="/tags.html#land-of-lisp-ref">land-of-lisp <span>20</span></a></li>
    
  



      
    </ul>
  </div>
</div>

<!-- Gplus -->
<!--script type="text/javascript">
  window.___gcfg = {lang: 'zh-CN'};

  (function() {
    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
    po.src = 'https://apis.google.com/js/plusone.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
  })();
</script>



      </div>

      <footer>
      <p>&copy; Reverland 2012 
      with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
      and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
      </p>
      </footer>

    </div> <!-- /container -->

    


  <script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-38681562-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>




    <script type="text/javascript" src="/js/sd.js"></script>
  </body>
  <div id="clustrmaps-widget" style="display: none"></div><script type="text/javascript">var _clustrmaps = {'url' : 'http://reverland.org', 'user' : 1079875, 'server' : '4', 'id' : 'clustrmaps-widget', 'version' : 1, 'date' : '2013-02-25', 'lang' : 'zh', 'corners' : 'square' };(function (){ var s = document.createElement('script'); s.type = 'text/javascript'; s.async = true; s.src = 'http://www4.clustrmaps.com/counter/map.js'; var x = document.getElementsByTagName('script')[0]; x.parentNode.insertBefore(s, x);})();</script><noscript><a href="http://www4.clustrmaps.com/user/16b107a43"><img src="http://www4.clustrmaps.com/stats/maps-no_clusters/reverland.org-thumb.jpg" alt="Locations of visitors to this page" /></a></noscript>
</html>

